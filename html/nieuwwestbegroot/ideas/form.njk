{% extends 'ideas.njk' %}
{% set pageTitle = 'Uw plan insturen' if not idea.id else 'Plan bewerken' %}
{% set contentClass = 'newIdea' %}
{% import 'includes/howdoesitwork.njk' as howdoesitwork %}
{% import 'includes/openstad-map.njk' as openStadMap %}

{% set summaryMaxLength = config.ideas.summaryMaxLength or 140 %}

{% block head %}
	{{ super() }}
	<link rel="stylesheet" type="text/css" href="/lib/trix/dist/trix.css">
{% endblock %}

{% block content %}

	{% if not user.isLoggedIn() %}
		<a href="/account/register?ref=/idea/nieuw" class="meldjeaanknop">Meld u aan om een plan in te sturen</a>
	{% else %}
		<h1>{{pageTitle}}</h1>
	{% endif %}

	{% if showHelp %}
	{% endif %}

	{% if showForm %}
		<div class="primary" id="formulier-block">
			<form id="posterImageUpload" action="/image"
	    {% if idea.posterImage %}
	    style="background-image: url('/image/{{idea.posterImage.key}}');"
	    {% endif %}
			>
				<div class="progress"><div class="bar"></div></div>
				<button type="button">Verwijder afbeelding<!-- Also set in JS --></button>
			</form>

			<form method="post" id="js-form">
				<div id="titleAndSummary">
					<h2>Naam</h2>
					{% if user and user.role and user.role == 'admin' %}
						<div class="form-info">Toon deze naam bij dit plan</div>
						<input type="text" id="inzenderNaam" value="{% if idea.extraData and idea.extraData.inzender %}{{idea.extraData.inzender.naam}}{% endif %}"><br>
						<br/>
					{% else %}
						<p>{{user.fullName}} <em>(uw naam is zichtbaar bij uw plan - uw emailadres wordt nooit gepubliceerd)</em></p>
					{% endif %}
					
					{% if user and user.role and user.role == 'admin' %}
						<h2>Email</h2>
						<div class="form-info">Toon dit email adres bij dit plan</div>
						<input type="text" id="inzenderEmail" value="{% if idea.extraData and idea.extraData.inzender %}{{idea.extraData.inzender.email}}{% endif %}"><br>
						<br/>
					{% endif %}
					
					<h2>Titel plan</h2>
					<div class="form-info">Geef uw voorstel een duidelijke naam, zodat anderen uw inzending makkelijk kunnen vinden en direct snappen waar het over gaat.</div>
					<input type="text" name="title" value="{{idea.title}}"><br>

					<input type="hidden" id="extraData" name="extraData" value=""><br>
					
					<h2>Thema</h2>
					<div class="form-info">Selecteer het thema waarop uw plan betrekking heeft.</div>
					<select id="thema" class="default-select" value="{% if idea.extraData %}{{idea.extraData.thema}}{% endif %}">
						<option value="">Kies thema</option>
						<option value="Samen dingen doen" {% if (idea.extraData) and (idea.extraData.thema == "Samen dingen doen") %}selected{% endif %}>Samen dingen doen</option>
						<option value="Cultuur en kansen creëren" {% if (idea.extraData) and (idea.extraData.thema == "Cultuur en kansen creëren") %}selected{% endif %}>Cultuur en kansen creëren</option>
						<option value="Veilige, groene en prettige buurt" {% if (idea.extraData) and (idea.extraData.thema == "Veilige, groene en prettige buurt") %}selected{% endif %}>Veilige, groene en prettige buurt</option>
					</select>
					<br>
					
					<h2>Samenvatting</h2>
					<div class="form-info">Geef hier eerst een korte samenvatting van uw plan. In de volgende stap kunt u uw voorstel uitgebreider uitleggen.</div>
					<textarea name="summary">{{idea.summary}}</textarea>
					<div id="charsLeft">U hebt nog <span>{{summaryMaxLength}}</span> tekens over.</div>
				</div>
				
				<div id="description">
					<h2>Beschrijving</h2>
					<div class="form-info">
						Gebruik de ruimte hieronder om uw voorstel verder uit te leggen.
						<ul>
							<li>Wat is het verhaal achter uw plan?</li>
							<li>Waarom past dit plan goed bij het thema dat u gekozen heeft?</li>
							<li>Is het een plan dat u zelf wilt uitvoeren, of moet het door een organisatie of de gemeente uitgevoerd worden?</li>
							<li>Wat wilt u ermee bereiken?</li>
							<li>Draag argumenten aan om mensen uit Slotermeer Noordoost te overtuigen op uw plan te stemmen. Uw plan heeft minimaal 30 likes nodig om door te gaan naar de volgende fase.</li>
						</ul>
					</div>
					{% if useModernEditor %}
						<input type="hidden" id="js-description" name="description" value="{{idea.description}}">
						
						<trix-toolbar id="trixToolbar">
							<div class="button_row">
								<span class="button_group text_tools">
									<button type="button" class="icon heading-1" data-trix-attribute="heading1" title="Titel">Heading</button>
									<button type="button" class="icon bold" data-trix-attribute="bold" data-trix-key="b" title="Vetgedrukt">Bold</button>
									<button type="button" class="icon italic" data-trix-attribute="italic" data-trix-key="i" title="Cursief">Italic</button>
									{# <button type="button" class="icon strike" data-trix-attribute="strike" title="Doorstrepen">Strikethrough</button> #}
									<button type="button" class="icon link" data-trix-attribute="href" data-trix-action="link" data-trix-key="k" title="Link">Link</button>
								</span>

								<span class="button_group text_tools">
									{# <button type="button" class="icon quote" data-trix-attribute="quote" title="Quote">Quote</button>
									<button type="button" class="icon code" data-trix-attribute="code" title="Code">Code</button> #}
									<button type="button" class="icon list bullets" data-trix-attribute="bullet" title="Opsomming">Bullets</button>
									<button type="button" class="icon list numbers" data-trix-attribute="number" title="Genummerde lijst">Numbers</button>
									<button type="button" class="icon nesting-level decrease" data-trix-action="decreaseNestingLevel" title="Inspringen vergroten" disabled="">Decrease Level</button>
									<button type="button" class="icon nesting-level increase" data-trix-action="increaseNestingLevel" title="Inspringen verkleinen" disabled="">Increase Level</button>
								</span>

								{# <span class="button_group history_tools">
								<button type="button" class="icon undo" data-trix-action="undo" data-trix-key="z" title="Undo" disabled="">Undo</button>
								<button type="button" class="icon redo" data-trix-action="redo" data-trix-key="shift+z" title="Redo" disabled="">Redo</button>
								</span> #}
							</div>

							<div class="dialogs">
								<div class="dialog link_dialog" data-trix-attribute="href" data-trix-dialog="href">
									<div class="link_url_fields">
										<input type="url" required="" name="href" placeholder="Enter a URL…">
										<div class="button_group">
											<input type="button" value="Link" data-trix-method="setAttribute">
											<input type="button" value="Unlink" data-trix-method="removeAttribute">
										</div>
									</div>
								</div>
							</div>
						</trix-toolbar>
						<trix-editor id="js-editor" class="userContentEditor" input="js-description" toolbar="trixToolbar"></trix-editor><br>
					{% else %}
						<textarea name="description">{{idea.description}}</textarea>
					{% endif %}
					<div id="charsLeftMain">Nog minimaal <span>140</span> tekens.</div><br/><br/>
					
					
					{% if idea.id %}
						<input type="hidden" name="id" value="{{idea.id}}">
						<input type="hidden" name="_method" value="PUT">
					{% endif %}
					<input type="hidden" name="_csrf" value="{{csrfToken}}">
				</div>
				
				<div id="location">
					<h2>Locatie</h2>
					<div class="form-info" style="height: auto;">Heeft uw plan betrekking op een specifieke locatie? Klik dan op de juiste locatie in de kaart om een vlaggetje te plaatsen. Klik nogmaals op het vlaggetje om deze weer te verwijderen.</div>
					<input type="hidden" id="locationField" name="location" value='{{idea.location | dump | safe}}'>
					<div id="mapcontainer">
						{{openStadMap.map(googleKey = config.openStadMap.googleKey, editorInputElementId = 'locationField')}}
					</div>
				</div>
				
				{% if idea.posterImage %}
					<input type="hidden" name="images[]" value="{{idea.posterImage.key}}">
				{% endif %}
				
				<input type="submit" value="Plan opslaan">
			</form>
		</div>

		<div class="secondary">
			<div class="pageContent">
			</div>
		</div>
	{% endif %}
{% endblock %}

{% block howDoesItWork %}
	{% if not user.isLoggedIn() %}
		{{howdoesitwork.howblock('open')}}
		<a href="/account/register?ref=/idea/nieuw" class="meldjeaanknop" style="margin-top: 100px; margin-bottom: 60px;">Meld u aan om een plan in te sturen</a>
	{% endif %}
{% endblock %}

{% block scripts %}
	{% if showForm %}
		<script src="/lib/dropzone/dist/dropzone.js"></script>
		<script src="/lib/trix/dist/trix.js"></script>
		<script src="/js/editor.js"></script>
		
		<script>
		 // Idea form extensions
		 // --------------------
						// Used by poster file upload and description editor to register
		 // a reference to each uploaded file. This reference list is used
		 // by the server to connect the correct image uploads to this idea.
			 var form = document.getElementById('js-form');
		 form.addAttachmentRef = function( key ) {
			 var input   = document.createElement('input');
			 input.type  = 'hidden';
			 input.name  = 'images[]';
			 input.value = key;
			 this.appendChild(input);
		 };
		 form.clearAttachmentRef = function() {
			 var images = Array.prototype.slice.call(
				 form.querySelectorAll('input[name="images[]"]'), 0
			 );
			 images.forEach(function( image ) {
				 this.removeChild(image);
			 }, this);
		 };
		 window.addEventListener('load', function( event ) {
			 var extraData = '{{idea.extraData}}';
			 if (extraData.replace)
				 extraData = extraData.replace(/&quot;/g, '"');
			 try {
				 extraData = JSON.parse(extraData)
			 } catch(error) {}
			 if ( extraData && extraData.thema ) {
				 document.getElementById('thema').value = extraData.thema;
			 }
			 if ( extraData && extraData.inzender && extraData.inzender.naam ) {
				 document.getElementById('inzenderNaam').value = extraData.inzender.naam;
			 }
			 if ( extraData && extraData.inzender && extraData.inzender.email ) {
				 document.getElementById('inzenderEmail').value = extraData.inzender.email;
			 }
			 
		 });
		 form.addEventListener('submit', function( event ) {

			 var uploadForm = document.getElementById('posterImageUpload');
			 if( !uploadForm ) return;
			 
			 if( uploadForm.classList.contains('uploading') ) {
				 event.stopPropagation();
				 event.preventDefault();
				 alert(
					 'De afbeelding upload is nog niet afgerond.\n\n'+
					 'Hierdoor kan uw idee nog niet opgeslagen worden.'
				 );
			 }

			 // extra data
			 var extraData = {
				 thema: document.getElementById('thema') && document.getElementById('thema').value,
				 inzender: {
					 naam: document.getElementById('inzenderNaam') && document.getElementById('inzenderNaam').value,
					 email: document.getElementById('inzenderEmail') && document.getElementById('inzenderEmail').value,
				 }
			 }
			 console.log(extraData)
			 document.getElementById('extraData').value = JSON.stringify(extraData);

		 });
		</script>	
		<script>
		 var currentImage;
		 var form        = document.getElementById('js-form');
		 var el          = document.getElementById('posterImageUpload');
		 var button      = el.querySelector('button');
		 var progressBar = el.querySelector('#posterImageUpload .progress .bar');
		 
		 button.addEventListener('click', function() {
			 upload.removeFile(currentImage || {});
		 });
		 
		 var upload = new Dropzone(el, {
			 maxFiles             : 1,
			 uploadMultiple       : false,
			 
			 maxFilesize          : 10,
			 maxThumbnailFilesize : 10,
			 thumbnailWidth       : 1800,
			 thumbnailHeight      : null,
			 
			 addedfile: function( file ) {
				 this.removeFile(currentImage || {});
				 currentImage = file;
				 
				 el.classList.add('uploading');
				 progressBar.style.width = 0;
				 
				 file.key = Date.now()+'-'+file.name;
				 this.options.params['key'] = file.key;
			 },
			 removedfile: function( file ) {
				 el.removeAttribute('style');
				 el.classList.remove('uploading');
				 form.clearAttachmentRef();
			 },
			 
			 thumbnail: function( file, dataURL ) {
				 el.setAttribute('style', 'background-image: url('+dataURL+')');
			 },
			 sending: function() {
				 button.innerHTML = 'Annuleer upload';
			 },
			 uploadprogress: function( file, progress, bytesSent ) {
				 progressBar.style.width = progress+'%';
			 },
			 
			 success: function( file ) {
				 el.classList.remove('uploading');
				 form.addAttachmentRef(file.key);
				 button.innerHTML = 'Verwijder afbeelding';
			 },
			 error: function( file, error ) {
				 button.innerHTML = 'Verwijder afbeelding';
				 this.removeFile(file);
				 if( typeof error != 'string' ) {
					 alert(error.message);
				 }
			 }
		 });
		</script>
		<script>
		 // Summary
		 // -------
						var maxLen    = {{summaryMaxLength}};
		 var textarea  = document.querySelector('textarea[name="summary"]');
		 var charsLeft = document.querySelector('#charsLeft span');
		 
		 updateCharsLeft();
		 textarea.addEventListener('keydown', function( event ) {
			 var len = textarea.value.length;
			 var key = event.key.toLowerCase();
			 
			 // Prevent input when maximum is reached.
				 if( len == maxLen ) {
					 switch( key ) {
						 case 'delete': case 'backspace':
						 case 'arrowdown': case 'arrowup':
						 case 'arrowleft': case 'arrowright':
							 return;
						 default:
							 event.preventDefault();
					 }
				 }
		 });
		 textarea.addEventListener('keyup', updateCharsLeft);
		 
		 function updateCharsLeft() {
			 charsLeft.innerHTML = maxLen - textarea.value.length;
			 if (maxLen >= textarea.value.length) {
				 charsLeft.style.color = '#9A9A9A';
			 } else {
				 charsLeft.style.color = 'red';
			 }
		 }
		</script>
		
		<script>

		 
		 // Main editor
		 // -----------
						var minLen = 140;
		 var charsLeftMain = document.querySelector('#charsLeftMain span');

		 setTimeout(() => {

			 {% if useModernEditor %}
			 initAttachmentManager(
				 document.getElementById('js-form'),
				 document.getElementById('js-editor').editor
			 );
			 var mainEditor  = document.getElementById('js-editor');
			 document.querySelector('#charsLeftMain').style.marginTop = '-20px';
			 {% else %}
			 var mainEditor  = document.querySelector('textarea[name="description"]');
			 {% endif %}
			 mainEditor.addEventListener('keyup', updateCharsLeftMain);

			 function updateCharsLeftMain() {
				 {% if useModernEditor %}
				 let length = minLen - mainEditor.innerHTML.length
				 {% else %}
				 let length = minLen - mainEditor.value.length
				 {% endif %}
				 if (length <= 0) {
					 document.querySelector('#charsLeftMain').style.display = 'none';
				 } else {
					 document.querySelector('#charsLeftMain').style.display = 'block';
					 document.querySelector('#charsLeftMain span').innerHTML = length;
				 }
			 }
			 
			 updateCharsLeftMain();

		 } , 1000);

		</script>


	{% endif %}
{% endblock %}


