{% extends '../ideas.njk' %}
{% import '../includes/secondary.njk' as sec %}

{% set pageTitle    = 'Ideeën' %}
{% set contentClass = 'ideasList' %}

{% block content %}
	<div id="map"></div>
	
	<div class="primary">
		{{sec.speechBubble()}}
		
		<a href="/hoe-werkt-het" id="howDoesItWork">Hoe werkt het?</a>
		
		<h2>Bewonersideeën voor West</h2>
		
		{# Weird formatting because of `display: inline-block` #}
		{% for idea in runningIdeas
		%}<div class="tile {{idea.status}} {{'USER' if user.id == idea.userId}}">
				<a href="/idea/{{idea.id}}">
				<div class="duration">
				{% if idea.duration > 0 %}
					Nog {{idea.duration | duration}}
				{% else %}
					Afgelopen
				{% endif %}
					
				</div>
				
				{% if idea.posterImage %}
					<div class="image" style="background-image: url(/image/{{idea.posterImage.key}});"></div>
				{% elif idea.location %}
					<div class="image" style="background-image: url(
						https://maps.googleapis.com/maps/api/streetview?size=800x600&location={{idea.location.coordinates[0]}},{{idea.location.coordinates[1]}}&heading=151.78&pitch=-0.76&key=AIzaSyCrp_kqFQoKEaW5DOEBVjAu61cRl3-T0Lg
					);"></div>
				{% else %}
					<div class="image"></div>
				{% endif %}
				
				<h3>{{idea.title}}</h3>
				{{idea.summary}}
				
				<div class="ideaProgress">
					<div class="bar" style="width: {{idea.progress}}%"></div>
				</div>
				
				<div class="ideaStats">
					<div class="count yes">{{idea.yes}}</div>
					<div class="count no">{{idea.no}}</div>
					<div class="count arguments">{{idea.argCount}}</div>
				</div>
				</a>
			</div>{%
		else %}
			<i>Nog geen ideeën!</i>
		{% endfor %}
		
		{% if can('ideas:archive') %}
		<a href="/ideas/archive" id="viewArchive">Bekijk het archief</a>
		{% endif %}
	</div>
	
	<div class="secondary">
		{{sec.speechBubble()}}
		
		{{sec.highlightedIdeas(highlightedIdeas)}}
		
		{{sec.agenda(upcomingMeetings)}}
	</div>
{% endblock %}

{% block footer %}
	{{ super () }}
	
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCauwsJ_4I3ri0rI-O5-82ncLLO_Cji8YY"></script>
	<script src="/js/map.js"></script>
	<script>
		var bounds;
		var map    = initMap(document.getElementById('map'), {
			center            : {lat: 52.3732175, lng: 4.8495996},
			zoom              : 13,
			maxZoom           : 14,
			draggable         : false,
			keyboardShortcuts : false,
			scrollwheel       : false
		});
		window.addEventListener('resize', function() {
			bounds && map.fitBounds(bounds);
		});
		
		var ideas = [
			//{% for idea in runningIdeas %}
			{id: {{idea.id}}, location: JSON.parse('{{idea.location | dump | safe}}' || null)},
			//{% endfor %}
		];
		ideas.forEach(function( idea ) {
			if( !idea.location ) return;
			if( !bounds ) {
				bounds = new google.maps.LatLngBounds();
			}
			
			var point  = idea.location;
			var marker = initMarker({
				position : {lat: point.coordinates[0], lng: point.coordinates[1]},
				map      : map
			});
			marker.addListener('click', function() {
				window.location.href = '/idea/'+idea.id;
			});
			bounds.extend(marker.getPosition());
		});
		bounds && map.fitBounds(bounds);
	</script>
{% endblock %}