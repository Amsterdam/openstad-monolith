{% extends '../ideas.njk' %}
{% import '../includes/content.njk' as content %}
{% import '../includes/secondary.njk' as sec %}

{% set pageTitle    = 'Ideeën' %}
{% set contentClass = 'ideasList' %}

{% block content %}
	{{content.map(cookieConsent)}}
	
	<div class="primary">
		{{sec.newIdeaBubble()}}
		
		<a href="/hoe-werkt-het" id="howDoesItWork">Hoe werkt het?</a>
		
		<h2>Bewonersideeën voor West</h2>
		
		{# Weird formatting because of `display: inline-block` #}
		{% for idea in runningIdeas
		%}<div class="tile {{idea.status}} {{'USER' if user.id == idea.userId}}">
				<a href="/plan/{{idea.id}}">
				<div class="duration">
				{% if idea.status == 'BUSY' %}
					Dit plan is in behandeling
				{% elif idea.status == 'ACCEPTED' %}
					Dit plan wordt besproken
				{% elif idea.status == 'DENIED' %}
					Afgelopen
				{% elif idea.duration > 0 %}
					Nog {{idea.duration | duration}}
				{% else %}
					Afgelopen
				{% endif %}
				</div>
				
				{% if idea.posterImage %}
					<div class="image" style="background-image: url('/image/{{idea.posterImage.key}}?thumb');"></div>
				{% elif idea.location %}
					<div class="image" style="background-image: url(
						'https://maps.googleapis.com/maps/api/streetview?size=800x600&location={{idea.location.coordinates[0]}},{{idea.location.coordinates[1]}}&heading=151.78&pitch=-0.76&key=AIzaSyCrp_kqFQoKEaW5DOEBVjAu61cRl3-T0Lg'
					);"></div>
				{% else %}
					<div class="image"></div>
				{% endif %}
				
				<div class="info">
					<h3>{{idea.title}}</h3>
					<p>{{idea.summary}}</p>
					
					<div class="ideaProgress">
						<div class="progress"><div class="bar" style="width: {{idea.progress}}%;"></div></div>
					</div>
					
					<div class="ideaStats">
						<div class="count yes">{{idea.yes}}</div>
						<div class="count no">{{idea.no}}</div>
						<div class="count arguments">{{idea.argCount}}</div>
					</div>
				</div>
				</a>
			</div>{%
		else %}
			<i>Nog geen ideeën!</i>
		{% endfor %}
		
		{# {% if can('ideas:archive') %}
		<a href="/plannen/archief" id="viewArchive">Bekijk het archief</a>
		{% endif %} #}
	</div>
	
	<div class="secondary">
		{{sec.newIdeaBubble()}}
		
		{{sec.highlightedIdeas(highlightedIdeas)}}
		
		{{sec.agenda(upcomingMeetings)}}
	</div>
{% endblock %}

{% block footer %}
	{{super()}}
	
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCauwsJ_4I3ri0rI-O5-82ncLLO_Cji8YY"></script>
	<script src="/js/map.js"></script>
	<script>
		var bounds;
		var map    = initMap(document.getElementById('map'), {
			center            : {lat: 52.3732175, lng: 4.8495996},
			zoom              : 13,
			maxZoom           : 17,
			draggable         : false,
			keyboardShortcuts : false,
			scrollwheel       : false,
			zoomControl       : true
		});
		function boundsLimiter() {
			google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
				if( map.getZoom() > 14 ) {
					map.setZoom(14);
				}
			});
		}
		window.addEventListener('resize', function() {
			if( bounds ){
				boundsLimiter();
				map.fitBounds(bounds);
			}
		});
		
		var ideas = [
			//{% for idea in runningIdeas %}
			{id: {{idea.id}}, location: JSON.parse('{{idea.location | dump | safe}}' || null)},
			//{% endfor %}
		];
		ideas.forEach(function( idea ) {
			if( !idea.location ) return;
			if( !bounds ) {
				bounds = new google.maps.LatLngBounds();
			}
			
			var point  = idea.location;
			var marker = initMarker({
				position : {lat: point.coordinates[0], lng: point.coordinates[1]},
				map      : map,
				icon     : {
					url    : '/img/flag_small.svg',
					size   : new google.maps.Size(22, 24),
					anchor : new google.maps.Point(4, 21)
				}
			});
			marker.addListener('click', function() {
				window.location.href = '/plan/'+idea.id;
			});
			bounds.extend(marker.getPosition());
		});
		if( bounds ) {
			boundsLimiter();
			map.fitBounds(bounds);
		}
	</script>
{% endblock %}