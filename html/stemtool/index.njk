{% extends 'base.njk' %}

{% set pageTitle    = 'Idee: '+idea.title %}
{% set contentClass = 'idea' %}

{% block head %}
	{{ super() }}
	<meta property="og:title" content="{{idea.title}}">
	<meta property="og:type" content="website">
	<meta property="og:description" content="{{idea.summary}}">
	<meta property="og:locale" content="nl_NL">
	<meta property="og:site_name" content="{{SITENAME}}">
	{% if idea.posterImage %}
		<meta property="og:image" content="/image/{{idea.posterImage.key}}">
	{% endif %}
{% endblock %}

{% block page %}
	<section id="summary" class="pageContent">
		<div class="primary">
			<div class="image"></div>
			
			<p>
				Samenvatting
			</p>
		</div>
		<div class="secondary controls">
			Controls
		</div>
	</section>
	
	<section id="designs">
		<div class="pageContent">
			<h1>Ontwerpen</h1>
		</div>
	</section>
	
	<section id="details" class="pageContent">
		<div class="primary">
			<h1>Achtergrondinformatie</h1>
			
			<div class="userContent">
				{{idea.description | safe}}
			</div>
		</div> <!-- #primary -->
		
		<div class="secondary">
			Agenda
			
			{% if can('idea:edit', 'idea:delete') %}
				<h2>Bewerken</h2>
				
				{% if can('idea:edit') %}
					<form action="/plan/{{idea.id}}/edit">
						<button type="submit" class="edit">Bewerk idee</button>
					</form>
				{% endif %}
				
				{% if can('idea:delete') %}
					<form method="POST" action="/plan/{{idea.id}}/delete" id="deleteIdea">
						<input type="hidden" name="_method" value="DELETE">
						<input type="hidden" name="_csrf" value="{{csrfToken}}">
						<button type="submit" class="delete">Verwijder idee</button>
					</form>
				{% endif %}
			{% endif %}
			
			{% if can('idea:admin') %}
				<h2>Beheren</h2>
				
				<form method="GET" action="/agenda/edit">
					<button type="submit" class="votes">Bewerk agenda</button>
				</form>
				
				<form method="GET" action="/plan/{{idea.id}}/votes">
					<button type="submit" class="votes">Stemoverzicht</button>
				</form>
			{% endif %}
		</div>
	</section>
{% endblock %}

{% block scripts %}
	<script src="/js/promise.js"></script>
	<script src="/js/fetch.js"></script>
	<script>
		// Helper for sending non-GET HTTP requests
		// ----------------------------------------
		// Used in progressive enhancement scripts to replace a 'old-school'
		// request with a `fetch`/`XMLHTTPRequest` action.
		(function( global ) {
			var csrfToken = '{{csrfToken}}';
			
			// Wrapper for fetch to POST/PUT data
			global.send = function( method, url, data ) {
				data._csrf = csrfToken;
				
				return fetch(url, {
					method      : method,
					headers     : {
						'Content-Type' : 'application/json',
						'Accept'       : 'application/json'
					},
					credentials : 'same-origin',
					body        : data ? JSON.stringify(data): null
				})
				.then(handleResponse)
				.then(function( data ) {
					if( 'csrfToken' in data ) {
						csrfToken = data.csrfToken;
						// HACK?: Update all tokens in static forms as well.
						$('form input[type="hidden"][name="_csrf"]').forEach(function( input ) {
							input.value = csrfToken;
						});
					}
					return data;
				});
			}
			
			function handleResponse( response ) {
				var json = response.json();
				if( response.status >= 200 && response.status < 300 ) {
					return json;
				} else {
					return json.then(function( data ) {throw data});
				}
			}
		})(this);
	</script>
	
	<script>
		// First image in content
		// ----------------------
		// If the content starts with an image, remove it from the content
		// since it's already visible as poster image.
		var figure = document.querySelector('.userContent figure:first-child');
		if( figure ) {
			var parent = figure.parentNode;
			if( parent.firstChild === figure ) {
				parent.removeChild(figure);
			}
		}
	</script>
	<script>
		// Delete idea confirmation
		// ------------------------
		var form = document.getElementById('deleteIdea');
		if( form ) {
			form.addEventListener('submit', function( event ) {
				var msg = 'Let op! Je staat op het punt je voorstel te verwijderen. '+
				          'Dit kan niet ongedaan gemaakt worden.\n\n'+
				          'Weet je het zeker?';
				if( !confirm(msg) ) {
					event.preventDefault();
				}
			});
		}
	</script>
	
	{% if idea.location %}
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCauwsJ_4I3ri0rI-O5-82ncLLO_Cji8YY"></script>
	<script src="/js/map.js"></script>
	<script>
		// Google map
		// ----------
		var point  = JSON.parse('{{idea.location | dump | safe}}' || null);
		var latLng = {lat: point.coordinates[0], lng: point.coordinates[1]};
		var map    = initMap(document.getElementById('map'), {
			center      : latLng,
			zoom        : 14,
			zoomControl : true,
			scrollwheel : false
		});
		var marker = initMarker({
			position : latLng,
			map      : map
		});
	</script>
	{% endif %}
{% endblock %}