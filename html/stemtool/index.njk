{% extends 'base.njk' %}

{% set pageTitle    = 'Idee: '+idea.title %}
{% set contentClass = 'idea' %}

{% block head %}
	{{ super() }}
	<meta property="og:title" content="{{idea.title}}">
	<meta property="og:type" content="website">
	<meta property="og:description" content="{{idea.summary}}">
	<meta property="og:locale" content="nl_NL">
	<meta property="og:site_name" content="{{SITENAME}}">
	{% if idea.posterImage %}
		<meta property="og:image" content="/image/{{idea.posterImage.key}}">
	{% endif %}
{% endblock %}

{% block page %}
	<section id="summary" class="pageContent">
		<div class="primary">
			<div class="image" style="background-image: url('/image/{{idea.posterImage.key}}');"></div>
			
			<p>
				{{idea.summary}}
			</p>
		</div>
		<div class="secondary controls">
			<a href="#vote">{{poll.totalVoteCount}} stemmen</a><br>
			<a href="#arguments">{{idea.argCount}} argumenten</a>
			<p>
			<a href="#vote">Breng jouw stem uit!</a><br>
			<a href="#arguments">Lees de reacties</a>
			<p>
			<a href="http://www.amsterdam.nl" target="_blank">Lees meer over dit project op amsterdam.nl</a>
		</div>
	</section>
	
	<!--
		This section differs from others: it does not use `div.primary`
		and `div.secondary`. Instead it uses one `div.pageContent` so it
		can be page wide. The proper content dimensions are controlled
		with margins. See `idea.less` for `#designs` and `content.less`
		for `.pageContent`.
	-->
	<section id="designs">
		<div class="pageContent">
			<h1>Ontwerpen</h1>
			
			<ul>
			{% for option in poll.options %}
				<li>{{option.title}}</li>
			{% endfor %}
			</ul>
		</div>
	</section>
	
	<section id="details" class="pageContent">
		<div class="primary">
			<h1>Achtergrondinformatie</h1>
			
			<div class="userContent">
				{{idea.description | safe}}
			</div>
			
			<h1>Hoe werkt het? (spelregels)</h1>
			<ul>
				<li>Zo werk het stemproces: hoe wordt de uitslag bepaald</li>
				<li>Wie mogen er stemmen...</li>
				<li>Hoe werkt het</li>
				<li>Waar kun je terecht met vragen</li>
				<li>Andere spelregels?</li>
				<li>Nader te bepalen samen met projectteam</li>
			</ul>
		</div> <!-- #primary -->
		
		<div id="agenda" class="secondary">
			{% for item in idea.agenda %}
				<div>
					<h2>{{item.startDate | date('D MMMM')}}</h2>
					{{item.description}}
					{% if item.actionText %}
					<a href="{{item.actionURL}}">{{item.actionText}}</a>
					{% endif %}
				</div>
			{% endfor %}
			
			{% if can('idea:admin') %}
				<h2>Bewerken</h2>
				
				<form action="/plan/{{idea.id}}/edit">
					<button type="submit" class="edit">Bewerk idee</button>
				</form>
				
				<form method="POST" action="/plan/{{idea.id}}/delete" id="deleteIdea">
					<input type="hidden" name="_method" value="DELETE">
					<input type="hidden" name="_csrf" value="{{csrfToken}}">
					<button type="submit" class="delete">Verwijder idee</button>
				</form>
				
				<h2>Beheren</h2>
				
				<form method="GET" action="/agenda/edit">
					<button type="submit" class="votes">Bewerk agenda</button>
				</form>
				
				<form method="GET" action="/plan/{{idea.id}}/votes">
					<button type="submit" class="votes">Stemoverzicht</button>
				</form>
			{% endif %}
		</div>
	</section>
	
	<section id="vote" class="pageContent">
		<div class="primary">
			{% if can('poll:vote') %}
				<h1>Stem op jouw favoriete ontwerp</h1>
				
				<form method="POST" action="/vote">
					<input type="hidden" name="_csrf" value="{{csrfToken}}">
					<input type="hidden" name="pollId" value="{{poll.id}}">
					
					{% for option in poll.options %}
						<label><input type="checkbox" name="choices[]" value="{{option.id}}">{{option.order}} {{option.title}} ({{option.voteCount}})</label><br>
					{% endfor %}
					
					Postcode: <input type="text" name="zipCode"><br>
					
					<input type="submit" value="Verstuur stem">
				</form>
			{% else %}
				<h1>Bedankt voor je stem!</h1>
				
				{% for option in poll.options %}
						<label><input type="checkbox" disabled>{{option.order}} {{option.title}} ({{option.voteCount}})</label><br>
					{% endfor %}
			{% endif %}
		</div>
	</section>
{% endblock %}

{% block scripts %}
	<script src="/js/promise.js"></script>
	<script src="/js/fetch.js"></script>
	<script>
		// Helper for sending non-GET HTTP requests
		// ----------------------------------------
		// Used in progressive enhancement scripts to replace a 'old-school'
		// request with a `fetch`/`XMLHTTPRequest` action.
		(function( global ) {
			var csrfToken = '{{csrfToken}}';
			
			// Wrapper for fetch to POST/PUT data
			global.send = function( method, url, data ) {
				data._csrf = csrfToken;
				
				return fetch(url, {
					method      : method,
					headers     : {
						'Content-Type' : 'application/json',
						'Accept'       : 'application/json'
					},
					credentials : 'same-origin',
					body        : data ? JSON.stringify(data): null
				})
				.then(handleResponse)
				.then(function( data ) {
					if( 'csrfToken' in data ) {
						csrfToken = data.csrfToken;
						// HACK?: Update all tokens in static forms as well.
						$('form input[type="hidden"][name="_csrf"]').forEach(function( input ) {
							input.value = csrfToken;
						});
					}
					return data;
				});
			}
			
			function handleResponse( response ) {
				var json = response.json();
				if( response.status >= 200 && response.status < 300 ) {
					return json;
				} else {
					return json.then(function( data ) {throw data});
				}
			}
		})(this);
	</script>
	
{% endblock %}