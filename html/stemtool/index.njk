{% extends 'base.njk' %}

{% set pageTitle    = 'Idee: '+idea.title %}
{% set contentClass = 'idea' %}
{% set alphabet = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j' , 'k'] %}
{% set paddedVoteCount = ("000" + poll.totalVoteCount).slice(-3) %}
{% set paddedArgumentCount = ("000" + idea.argCount).slice(-3) %}

{% block head %}
	{{ super() }}
	<meta property="og:title" content="{{idea.title}}">
	<meta property="og:type" content="website">
	<meta property="og:description" content="{{idea.summary}}">
	<meta property="og:locale" content="nl_NL">
	<meta property="og:site_name" content="{{SITENAME}}">

	{% if idea.posterImage %}
		<meta property="og:image" content="/image/{{idea.posterImage.key}}">
	{% endif %}
{% endblock %}

{% block page %}
	<div id="summary" class="section-container">
		<div class="col-container">
			<div class="col-9">
				<div id="banner">
					<div class="image"
						{% if idea.posterImage %}
							style="background-image: url('/image/{{idea.posterImage.key}}');"
						{% endif %}
					></div>
				</div>
				<p>
					{{idea.summary}}
				</p>
			</div>

			<div class="col-3 controls">
				<span class="widget speechBubble newIdeaBubble">
					1 brug, 6 mogelijke varianten
				</span>

				<a href="#vote" class="box-green margin-bottom-xs">
					<span class="margin-right-s">
						<span class="number-plate"> {{paddedVoteCount[0]}} </span>
						<span class="number-plate"> {{paddedVoteCount[1]}} </span>
						<span class="number-plate"> {{paddedVoteCount[2]}} </span>
					</span>
						stemmen
				</a>
				<a href="#arguments" class="box-green">
					<span class="margin-right-s">
						<span class="number-plate"> {{paddedArgumentCount[0]}} </span>
						<span class="number-plate"> {{paddedArgumentCount[1]}} </span>
						<span class="number-plate"> {{paddedArgumentCount[2]}} </span>
					</span>

					argumenten
				</a>
				<br />

				<a href="#arguments" class="box-grey-img scroll-link">
					<img src="/img/stemtool/comments.svg" />
					Lees de reacties
				</a>

				<br />

				<a href="#vote" class="box-grey-img scroll-link">
					<img src="/img/stemtool/vote.svg" />
					Breng jouw stem uit!
				</a>

				<br />

				<a href="http://www.amsterdam.nl" class="box-grey-img" target="_blank">
					<img src="/img/stemtool/info.svg" />
					Lees meer over dit project op amsterdam.nl
				</a>
				<br />
			</div>
		</div>
	</div>


	<section id="designs" class="content-section">
		<div class="section-container">
			<h2>De varianten</h2>

			<div class="col-container">
				{% for option in poll.options
				%}<div class="col-3">
						<div class="concept-card">
							<div
								class="concept-card-image"
								style="background-image: url('img/stemtool/placeholder-concept.jpg');"
							>
								<div class="concept-card-number concept-card-number-{{loop.index}}">
									{{alphabet[loop.index - 1].toUpperCase()}}
								</div>
								<div class="concept-card-title">
									`{{option.title}}`
								</div>
							</div>
							<div>
								<a href="#" class="concept-card-link">
									<img src="/img/stemtool/red-arrow.svg" />
									Lees meer
								</a>
								<a href="#" class="concept-card-link">
									<img src="/img/stemtool/red-arrow.svg" />
									Lees reacties
								</a>
							</div>
						</div>
					</div>{%
				endfor %}
			</div>
	</section>

	<section id="details" class="content-section section-container">
		<div class="col-container">
			<div class="col-9">
				<h2>Achtergrondinformatie</h2>

				<div class="userContent">
					{{idea.description | safe}}
				</div>

				<h2>Hoe werkt het? (spelregels)</h2>
				<ul class="checkmark-list">
					<li>Zo werk het stemproces: hoe wordt de uitslag bepaald</li>
					<li>Wie mogen er stemmen...</li>
					<li>Hoe werkt het</li>
					<li>Waar kun je terecht met vragen</li>
					<li>Andere spelregels?</li>
					<li>Nader te bepalen samen met projectteam</li>
				</ul>
				<br />

				<a href="https://www.amsterdam.nl" target="black" class="box-grey">
					Lees meer over dit project op amsterdam.nl
				</a>

				{% if can('poll:vote') %}
					<div class="container-grey container-grey-edges margin-hor-m">
						<h2 class="h1">Stem op jouw favoriete ontwerp</h2>

						<hr class="hr-white margin-hor-m"></hr>

						<form method="POST" action="/vote">
							<input type="hidden" name="_csrf" value="{{csrfToken}}">
							<input type="hidden" name="pollId" value="{{poll.id}}">

							<label class="h3 block margin-bottom-s margin-top-0">
								Ik stem op:
								<span class="required-text">(verplicht)</span>
							</label>
							{% for option in poll.options %}
								<label class="concept-label">
									<div
										class="concept-card-image"
										style="background-image: url('img/stemtool/placeholder-concept.jpg');"
									>
										<div class="concept-card-number concept-card-number-{{loop.index}}">
											{{alphabet[loop.index - 1].toUpperCase()}}
										</div>
									</div>

									<div class="concept-card-title">
										<input type="checkbox" name="choices[]" value="{{option.id}}">{{option.order}} {{option.title}} ({{option.voteCount}})</label>
									</div>
								</label>

								<br />
							{% endfor %}

							<div class="margin-hor-m">
								<label class="h3 block margin-hor-xs"> Naam: <span class="required-text">(verplicht)</span></label>
								<input type="text" name="fullName" class="input-field">
							</div>
							<div  class="margin-hor-m">
								<label class="h3 block margin-hor-xs"> Postcode: <span class="required-text">(verplicht)</span>  </label>
								<input type="text" name="zipCode" class="input-field">
							</div>
							<button type="submit" class="default btn btn-primary">
								Verzenden
							</button>
						</form>
						</div>

					{% else %}
						<h2>Bedankt voor je stem!</h2>

						{% for option in poll.options %}
								<label><input type="checkbox" disabled>{{option.order}} {{option.title}} ({{option.voteCount}})</label><br>
							{% endfor %}
				{% endif %}

		</div>
		<div class="col-3">
			<div id="agenda">
				<h2>Proces</h2>

				<div class="agenda">
				{% for item in idea.agenda %}
					<div class="box-grey {{'agenda-period' if item.endDate else 'agenda-day' }}">
						<h3 class="margin-top-0 margin-bottom-s h3">{{item.startDate | date('D MMMM')}}</h3>
						{{item.description}}
						{% if item.actionText %}
						<a href="{{item.actionURL}}" class="block">{{item.actionText}}</a>
						{% endif %}
					</div>
				{% endfor %}
				</div>
			</div>

			{% if can('idea:admin') %}
				<h2>Bewerken</h2>

				<form action="/plan/{{idea.id}}/edit">
					<button type="submit" class="edit">Bewerk idee</button>
				</form>

				<form method="POST" action="/plan/{{idea.id}}/delete" id="deleteIdea">
					<input type="hidden" name="_method" value="DELETE">
					<input type="hidden" name="_csrf" value="{{csrfToken}}">
					<button type="submit" class="delete">Verwijder idee</button>
				</form>

				<h2>Beheren</h2>

				<form method="GET" action="/agenda/edit">
					<button type="submit" class="votes">Bewerk agenda</button>
				</form>

				<form method="GET" action="/plan/{{idea.id}}/votes">
					<button type="submit" class="votes">Stemoverzicht</button>
				</form>
			{% endif %}

			<h2>Heb je nog even?</h2>
			<div class="box-grey">

				<h3>
					We hebben nog twee extra vragen
					over wat jij belangrijk vindt
					in de uitwerking van de brug.
					Laat jij je stem horen?
				</h3>
				<p>
					Dit kost hooguit 2 minuten
					van je tijd?
				</p>
				<a href="https://www.amsterdam.nl" target="_blank" class="carret-link">
					Ja, ga naar vragenlijst
				</a>
			</div>


			</div>
		</div>
	</section>

	<section id="arguments">

	</section>

{% endblock %}

{% block scripts %}
	<script src="/js/promise.js"></script>
	<script src="/js/fetch.js"></script>
	<script>
		// Helper for sending non-GET HTTP requests
		// ----------------------------------------
		// Used in progressive enhancement scripts to replace a 'old-school'
		// request with a `fetch`/`XMLHTTPRequest` action.
		(function( global ) {
			var csrfToken = '{{csrfToken}}';

			// Wrapper for fetch to POST/PUT data
			global.send = function( method, url, data ) {
				data._csrf = csrfToken;

				return fetch(url, {
					method      : method,
					headers     : {
						'Content-Type' : 'application/json',
						'Accept'       : 'application/json'
					},
					credentials : 'same-origin',
					body        : data ? JSON.stringify(data): null
				})
				.then(handleResponse)
				.then(function( data ) {
					if( 'csrfToken' in data ) {
						csrfToken = data.csrfToken;
						// HACK?: Update all tokens in static forms as well.
						$('form input[type="hidden"][name="_csrf"]').forEach(function( input ) {
							input.value = csrfToken;
						});
					}
					return data;
				});
			}

			function handleResponse( response ) {
				var json = response.json();
				if( response.status >= 200 && response.status < 300 ) {
					return json;
				} else {
					return json.then(function( data ) {throw data});
				}
			}
		})(this);
	</script>

	<script>
		// First image in content
		// ----------------------
		// If the content starts with an image, remove it from the content
		// since it's already visible as poster image.
		var figure = document.querySelector('.userContent figure:first-child');
		if( figure ) {
			var parent = figure.parentNode;
			if( parent.firstChild === figure ) {
				parent.removeChild(figure);
			}
		}
	</script>
	<script>
		// Delete idea confirmation
		// ------------------------
		var form = document.getElementById('deleteIdea');
		if( form ) {
			form.addEventListener('submit', function( event ) {
				var msg = 'Let op! Je staat op het punt je voorstel te verwijderen. '+
				          'Dit kan niet ongedaan gemaakt worden.\n\n'+
				          'Weet je het zeker?';
				if( !confirm(msg) ) {
					event.preventDefault();
				}
			});
		}
	</script>
{% endblock %}
